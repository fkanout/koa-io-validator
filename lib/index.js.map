{"version":3,"sources":["../src/index.js"],"names":["alternativeValidation","alternate","schema","values","error","v","handleErrorWithSource","Joi","alternatives","try","validateAsync","err","source","fn","inputs","query","params","body","headers","config","undefined","Object","prototype","toString","call","message","_config","denyUnknown","httpErrorCode","nextOnError","ctx","next","alternateSchema","alternateData","includes","request","object","unknown","headersLowered","keys","reduce","destination","key","toLowerCase","length","status","state","routeValidationError","throw"],"mappings":"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","sourcesContent":["import Joi from '@hapi/joi';\nexport { default as Joi } from '@hapi/joi';\n\nconst alternativeValidation = async (alternate, schema, values) => {\n  let error;\n  for (const v in values) {\n    try {\n      await handleErrorWithSource(\n        alternate,\n        Joi.alternatives().try({\n          ...schema\n        }).validateAsync(values[v])\n      );\n      return; // returning after first validation succeed\n    } catch (err) {\n      error = err;\n    }\n  }\n  // throwing last error \n  // TODO: should we fabricate our custom error indicating about failing alternatives and combining all errors messages?\n  throw error;\n}\n\nconst handleErrorWithSource = async (source, fn) => {\n  try {\n    await fn;\n  } catch (error) {\n    error.source = source;\n    throw error;\n  }\n};\nexport default inputs => {\n  const { query, params, body, headers, config } = inputs;\n\n  if (config !== undefined && Object.prototype.toString.call(config) !== '[object Object]') {\n    throw { message: `Route config, expecting config to be an Object` };\n  }\n\n  const _config = {\n    denyUnknown: [],\n    httpErrorCode: 400,\n    nextOnError: false,\n    alternate: [],\n    ...config\n  };\n\n  return async (ctx, next) => {\n    let alternateSchema = {};\n    let alternateData = {};\n\n    if (_config.alternate.includes('query')) {\n      alternateSchema = { query, ...alternateSchema };\n      alternateData = { query: { query: ctx.query }, ...alternateData }\n    }\n    \n    if (_config.alternate.includes('body')) {\n      alternateSchema = { body, ...alternateSchema };\n      alternateData = { body: { body: ctx.request.body }, ...alternateData }\n    }\n    \n    if (_config.alternate.includes('params')) {\n      alternateSchema = { params, ...alternateSchema };\n      alternateData = { params: { params: ctx.params }, ...alternateData }\n    }\n    \n    if (_config.alternate.includes('headers')) {\n      alternateSchema = { headers, ...alternateSchema };\n      alternateData = { headers: { headers: ctx.headers }, ...alternateData }\n    }\n    \n    try {\n      if (query && !_config.alternate.includes('query')) {\n        await handleErrorWithSource(\n          'query',\n          Joi.object(query)\n            .unknown(!_config.denyUnknown.includes('query'))\n            .validateAsync(ctx.query)\n        );\n      }\n\n      if (params && !_config.alternate.includes('params')) {\n        await handleErrorWithSource('params', Joi.object(params).validateAsync(ctx.params));\n      }\n\n      if (body && !_config.alternate.includes('body')) {\n        await handleErrorWithSource(\n          'body',\n          Joi.object(body)\n            .unknown(!_config.denyUnknown.includes('body'))\n            .validateAsync(ctx.request.body)\n        );\n      }\n\n\n      if (headers && !_config.alternate.includes('headers')) {\n        const headersLowered = Object.keys(headers).reduce((destination, key) => {\n          destination[key.toLowerCase()] = headers[key];\n          return destination;\n        }, {});\n        await handleErrorWithSource(\n          'headers',\n          Joi.object(headersLowered)\n            .unknown(!_config.denyUnknown.includes('headers'))\n            .validateAsync(ctx.headers)\n        );\n      }\n\n      // validation of alternates\n      if (_config.alternate.length) {\n        await alternativeValidation(_config.alternate, alternateSchema, alternateData);\n      }\n\n      await next();\n      // Output validator\n      if (inputs[ctx.status]) {\n        await handleErrorWithSource('output', Joi.object(inputs[ctx.status]).validateAsync(ctx.body));\n      }\n    } catch (error) {\n      if (_config.nextOnError) {\n        ctx.state.routeValidationError = error;\n        if (error.source !== 'output') await next();\n      } else {\n        ctx.throw(_config.httpErrorCode, error);\n      }\n    }\n  };\n};\n"],"file":"index.js"}