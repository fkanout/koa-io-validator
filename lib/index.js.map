{"version":3,"sources":["../src/index.js"],"names":["handleErrorWithSource","source","fn","error","inputs","query","params","body","headers","config","undefined","Object","prototype","toString","call","message","_config","denyUnknown","httpErrorCode","nextOnError","ctx","next","Joi","object","unknown","includes","validateAsync","request","headersLowered","keys","reduce","destination","key","toLowerCase","status","state","routeValidationError","throw"],"mappings":"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","sourcesContent":["import Joi from \"@hapi/joi\";\nexport { default as Joi } from \"@hapi/joi\";\n\nconst handleErrorWithSource = async (source, fn) => {\n  try {\n    await fn;\n  } catch (error) {\n    error.source = source;\n    throw error;\n  }\n};\nexport default inputs => {\n  const { query, params, body, headers, config } = inputs;\n\n  if (config !== undefined && Object.prototype.toString.call(config) !== \"[object Object]\") {\n    throw { message: `Route config, expecting config to be an Object` };\n  }\n\n  const _config = {\n    denyUnknown: [],\n    httpErrorCode: 400,\n    nextOnError: false,\n    ...config\n  };\n\n  return async (ctx, next) => {\n    try {\n      if (query) {\n        await handleErrorWithSource(\n          \"query\",\n          Joi.object(query)\n            .unknown(!_config.denyUnknown.includes(\"query\"))\n            .validateAsync(ctx.query)\n        );\n      }\n      if (params) {\n        await handleErrorWithSource(\"params\", Joi.object(params).validateAsync(ctx.params));\n      }\n      if (body) {\n        await handleErrorWithSource(\n          \"body\",\n          Joi.object(body)\n            .unknown(!_config.denyUnknown.includes(\"body\"))\n            .validateAsync(ctx.request.body)\n        );\n      }\n      if (headers) {\n        const headersLowered = Object.keys(headers).reduce((destination, key) => {\n          destination[key.toLowerCase()] = headers[key];\n          return destination;\n        }, {});\n        await handleErrorWithSource(\n          \"headers\",\n          Joi.object(headersLowered)\n            .unknown(!_config.denyUnknown.includes(\"headers\"))\n            .validateAsync(ctx.headers)\n        );\n      }\n      await next();\n      // Output validator\n      if (inputs[ctx.status]) {\n        await handleErrorWithSource(\"output\", Joi.object(inputs[ctx.status]).validateAsync(ctx.body));\n      }\n    } catch (error) {\n      if (_config.nextOnError) {\n        ctx.state.routeValidationError = error;\n        if (error.source !== \"output\") await next();\n      } else {\n        ctx.throw(_config.httpErrorCode, error);\n      }\n    }\n  };\n};\n"],"file":"index.js"}